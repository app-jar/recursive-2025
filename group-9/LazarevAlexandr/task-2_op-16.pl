% Номер 2. Задача 16
% Решение 3x3 системы вручную
solve3(Matrix, D, [X, Y, Z]) :-
    % Разворачиваем строки матрицы и правую часть
    Matrix = [[A1, B1, C1],
              [A2, B2, C2],
              [A3, B3, C3]],
    D = [D1, D2, D3],

    % === Проверяем первый ведущий элемент ===
    ( A1 =:= 0 ->
        % Если первый элемент 0, меняем строки
        ( A2 =\= 0 ->
            swap_rows([A1,B1,C1,D1],[A2,B2,C2,D2], R1, R2),
            Matrix1 = [R1, R2, [A3,B3,C3,D3]]
        ; A3 =\= 0 ->
            swap_rows([A1,B1,C1,D1],[A3,B3,C3,D3], R1, R3),
            Matrix1 = [R1, [A2,B2,C2,D2], R3]
        ; writeln('Ошибка: первый столбец полностью нулевой!'), !, fail
        )
    ; Matrix1 = [[A1,B1,C1,D1],[A2,B2,C2,D2],[A3,B3,C3,D3]]
    ),

    % === Прямой ход ===
    Matrix1 = [[A1_,B1_,C1_,D1_],
               [A2_,B2_,C2_,D2_],
               [A3_,B3_,C3_,D3_]],

    % Обнуляем под первым элементом
    F2 is A2_/A1_, F3 is A3_/A1_,
    B2p is B2_ - F2*B1_, C2p is C2_ - F2*C1_, D2p is D2_ - F2*D1_,
    B3p is B3_ - F3*B1_, C3p is C3_ - F3*C1_, D3p is D3_ - F3*D1_,

    % Проверяем второй ведущий элемент
    ( B2p =:= 0 ->
        ( B3p =\= 0 ->
            swap_rows([B2p,C2p,D2p],[B3p,C3p,D3p], R2, R3),
            [B2p_,C2p_,D2p_] = R2,
            [B3p_,C3p_,D3p_] = R3
        ; writeln('Ошибка: вырожденная система!'), !, fail
        )
    ; B2p_ = B2p, C2p_ = C2p, D2p_ = D2p,
      B3p_ = B3p, C3p_ = C3p, D3p_ = D3p
    ),

    % Обнуляем под вторым элементом
    F is B3p_/B2p_,
    C3pp is C3p_ - F*C2p_,
    D3pp is D3p_ - F*D2p_,

    % Проверяем третий ведущий элемент
    ( C3pp =:= 0 ->
        writeln('Ошибка: последний ведущий элемент равен 0, система вырождена!'), !, fail
    ; true
    ),

    % === Обратный ход ===
    Z is D3pp / C3pp,
    Y is (D2p_ - C2p_*Z) / B2p_,
    X is (D1_ - B1_*Y - C1_*Z) / A1_.

% --- Вспомогательный предикат для перестановки строк ---
swap_rows(Row1, Row2, Row2, Row1).

